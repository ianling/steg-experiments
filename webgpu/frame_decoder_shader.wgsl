const fuzziness = 17 / 255.0;
const frameWidth = 1280;
const frameHeight = 720;
const tileWidth = 48;
const tileHeight = 48;

const columns = frameWidth / tileWidth;
const rows = frameHeight / tileHeight;
const numTiles = columns * rows;

const palette = array(
        vec3f(16.0/255.0, 16.0/255.0, 16/255.0),
        vec3f(14.0/255.0, 14.0/255.0, 51/255.0),
        vec3f(16.0/255.0, 15.0/255.0, 88/255.0),
        vec3f(16.0/255.0, 16.0/255.0, 125/255.0),
        vec3f(14.0/255.0, 14.0/255.0, 163/255.0),
        vec3f(16.0/255.0, 15.0/255.0, 200/255.0),
        vec3f(14.0/255.0, 15.0/255.0, 235/255.0),
        vec3f(14.0/255.0, 52.0/255.0, 14/255.0),
        vec3f(15.0/255.0, 52.0/255.0, 51/255.0),
        vec3f(15.0/255.0, 52.0/255.0, 90/255.0),
        vec3f(14.0/255.0, 52.0/255.0, 126/255.0),
        vec3f(15.0/255.0, 51.0/255.0, 162/255.0),
        vec3f(15.0/255.0, 52.0/255.0, 200/255.0),
        vec3f(14.0/255.0, 51.0/255.0, 237/255.0),
        vec3f(15.0/255.0, 88.0/255.0, 14/255.0),
        vec3f(16.0/255.0, 89.0/255.0, 53/255.0),
        vec3f(14.0/255.0, 88.0/255.0, 89/255.0),
        vec3f(16.0/255.0, 89.0/255.0, 126/255.0),
        vec3f(15.0/255.0, 89.0/255.0, 162/255.0),
        vec3f(16.0/255.0, 88.0/255.0, 199/255.0),
        vec3f(16.0/255.0, 89.0/255.0, 238/255.0),
        vec3f(15.0/255.0, 126.0/255.0, 14/255.0),
        vec3f(14.0/255.0, 126.0/255.0, 52/255.0),
        vec3f(15.0/255.0, 126.0/255.0, 89/255.0),
        vec3f(15.0/255.0, 126.0/255.0, 126/255.0),
        vec3f(15.0/255.0, 125.0/255.0, 163/255.0),
        vec3f(15.0/255.0, 125.0/255.0, 200/255.0),
        vec3f(14.0/255.0, 125.0/255.0, 236/255.0),
        vec3f(14.0/255.0, 162.0/255.0, 15/255.0),
        vec3f(16.0/255.0, 163.0/255.0, 52/255.0),
        vec3f(15.0/255.0, 163.0/255.0, 88/255.0),
        vec3f(14.0/255.0, 163.0/255.0, 127/255.0),
        vec3f(15.0/255.0, 162.0/255.0, 163/255.0),
        vec3f(14.0/255.0, 163.0/255.0, 199/255.0),
        vec3f(16.0/255.0, 162.0/255.0, 236/255.0),
        vec3f(15.0/255.0, 200.0/255.0, 15/255.0),
        vec3f(15.0/255.0, 200.0/255.0, 52/255.0),
        vec3f(13.0/255.0, 200.0/255.0, 89/255.0),
        vec3f(15.0/255.0, 199.0/255.0, 126/255.0),
        vec3f(13.0/255.0, 199.0/255.0, 162/255.0),
        vec3f(15.0/255.0, 199.0/255.0, 199/255.0),
        vec3f(15.0/255.0, 200.0/255.0, 238/255.0),
        vec3f(15.0/255.0, 237.0/255.0, 14/255.0),
        vec3f(15.0/255.0, 236.0/255.0, 53/255.0),
        vec3f(15.0/255.0, 236.0/255.0, 89/255.0),
        vec3f(15.0/255.0, 238.0/255.0, 126/255.0),
        vec3f(14.0/255.0, 238.0/255.0, 163/255.0),
        vec3f(15.0/255.0, 237.0/255.0, 201/255.0),
        vec3f(14.0/255.0, 237.0/255.0, 237/255.0),
        vec3f(51.0/255.0, 14.0/255.0, 13/255.0),
        vec3f(51.0/255.0, 15.0/255.0, 53/255.0),
        vec3f(51.0/255.0, 14.0/255.0, 88/255.0),
        vec3f(51.0/255.0, 15.0/255.0, 125/255.0),
        vec3f(53.0/255.0, 15.0/255.0, 165/255.0),
        vec3f(51.0/255.0, 14.0/255.0, 198/255.0),
        vec3f(52.0/255.0, 15.0/255.0, 237/255.0),
        vec3f(52.0/255.0, 51.0/255.0, 15/255.0),
        vec3f(53.0/255.0, 53.0/255.0, 53/255.0),
        vec3f(52.0/255.0, 52.0/255.0, 89/255.0),
        vec3f(53.0/255.0, 52.0/255.0, 125/255.0),
        vec3f(52.0/255.0, 52.0/255.0, 161/255.0),
        vec3f(51.0/255.0, 51.0/255.0, 200/255.0),
        vec3f(53.0/255.0, 52.0/255.0, 237/255.0),
        vec3f(53.0/255.0, 89.0/255.0, 16/255.0),
        vec3f(51.0/255.0, 89.0/255.0, 51/255.0),
        vec3f(53.0/255.0, 90.0/255.0, 89/255.0),
        vec3f(51.0/255.0, 88.0/255.0, 126/255.0),
        vec3f(51.0/255.0, 89.0/255.0, 163/255.0),
        vec3f(52.0/255.0, 88.0/255.0, 199/255.0),
        vec3f(51.0/255.0, 88.0/255.0, 236/255.0),
        vec3f(51.0/255.0, 125.0/255.0, 14/255.0),
        vec3f(52.0/255.0, 125.0/255.0, 51/255.0),
        vec3f(52.0/255.0, 125.0/255.0, 89/255.0),
        vec3f(51.0/255.0, 125.0/255.0, 126/255.0),
        vec3f(53.0/255.0, 126.0/255.0, 163/255.0),
        vec3f(51.0/255.0, 125.0/255.0, 198/255.0),
        vec3f(53.0/255.0, 125.0/255.0, 236/255.0),
        vec3f(53.0/255.0, 163.0/255.0, 15/255.0),
        vec3f(51.0/255.0, 162.0/255.0, 50/255.0),
        vec3f(51.0/255.0, 163.0/255.0, 89/255.0),
        vec3f(52.0/255.0, 163.0/255.0, 126/255.0),
        vec3f(51.0/255.0, 162.0/255.0, 162/255.0),
        vec3f(53.0/255.0, 163.0/255.0, 201/255.0),
        vec3f(52.0/255.0, 162.0/255.0, 237/255.0),
        vec3f(53.0/255.0, 201.0/255.0, 16/255.0),
        vec3f(51.0/255.0, 199.0/255.0, 52/255.0),
        vec3f(53.0/255.0, 200.0/255.0, 89/255.0),
        vec3f(51.0/255.0, 199.0/255.0, 124/255.0),
        vec3f(51.0/255.0, 200.0/255.0, 164/255.0),
        vec3f(53.0/255.0, 200.0/255.0, 201/255.0),
        vec3f(51.0/255.0, 200.0/255.0, 236/255.0),
        vec3f(51.0/255.0, 237.0/255.0, 15/255.0),
        vec3f(52.0/255.0, 237.0/255.0, 52/255.0),
        vec3f(51.0/255.0, 236.0/255.0, 88/255.0),
        vec3f(51.0/255.0, 238.0/255.0, 127/255.0),
        vec3f(52.0/255.0, 236.0/255.0, 163/255.0),
        vec3f(51.0/255.0, 237.0/255.0, 200/255.0),
        vec3f(52.0/255.0, 236.0/255.0, 236/255.0),
        vec3f(89.0/255.0, 15.0/255.0, 15/255.0),
        vec3f(88.0/255.0, 14.0/255.0, 51/255.0),
        vec3f(89.0/255.0, 15.0/255.0, 88/255.0),
        vec3f(89.0/255.0, 16.0/255.0, 127/255.0),
        vec3f(89.0/255.0, 14.0/255.0, 162/255.0),
        vec3f(89.0/255.0, 15.0/255.0, 200/255.0),
        vec3f(89.0/255.0, 14.0/255.0, 235/255.0),
        vec3f(89.0/255.0, 51.0/255.0, 14/255.0),
        vec3f(89.0/255.0, 52.0/255.0, 51/255.0),
        vec3f(88.0/255.0, 52.0/255.0, 90/255.0),
        vec3f(89.0/255.0, 52.0/255.0, 126/255.0),
        vec3f(88.0/255.0, 52.0/255.0, 162/255.0),
        vec3f(90.0/255.0, 52.0/255.0, 202/255.0),
        vec3f(89.0/255.0, 52.0/255.0, 236/255.0),
        vec3f(88.0/255.0, 88.0/255.0, 14/255.0),
        vec3f(90.0/255.0, 89.0/255.0, 53/255.0),
        vec3f(89.0/255.0, 89.0/255.0, 89/255.0),
        vec3f(89.0/255.0, 89.0/255.0, 126/255.0),
        vec3f(90.0/255.0, 89.0/255.0, 162/255.0),
        vec3f(89.0/255.0, 89.0/255.0, 198/255.0),
        vec3f(89.0/255.0, 89.0/255.0, 238/255.0),
        vec3f(88.0/255.0, 126.0/255.0, 16/255.0),
        vec3f(89.0/255.0, 125.0/255.0, 52/255.0),
        vec3f(88.0/255.0, 126.0/255.0, 88/255.0),
        vec3f(90.0/255.0, 127.0/255.0, 126/255.0),
        vec3f(88.0/255.0, 125.0/255.0, 163/255.0),
        vec3f(88.0/255.0, 126.0/255.0, 200/255.0),
        vec3f(89.0/255.0, 125.0/255.0, 236/255.0),
        vec3f(88.0/255.0, 162.0/255.0, 15/255.0),
        vec3f(89.0/255.0, 163.0/255.0, 52/255.0),
        vec3f(89.0/255.0, 162.0/255.0, 88/255.0),
        vec3f(89.0/255.0, 162.0/255.0, 126/255.0),
        vec3f(89.0/255.0, 163.0/255.0, 164/255.0),
        vec3f(89.0/255.0, 162.0/255.0, 199/255.0),
        vec3f(89.0/255.0, 163.0/255.0, 236/255.0),
        vec3f(88.0/255.0, 200.0/255.0, 14/255.0),
        vec3f(90.0/255.0, 200.0/255.0, 52/255.0),
        vec3f(88.0/255.0, 199.0/255.0, 87/255.0),
        vec3f(88.0/255.0, 200.0/255.0, 126/255.0),
        vec3f(90.0/255.0, 201.0/255.0, 164/255.0),
        vec3f(88.0/255.0, 199.0/255.0, 199/255.0),
        vec3f(90.0/255.0, 200.0/255.0, 238/255.0),
        vec3f(89.0/255.0, 236.0/255.0, 16/255.0),
        vec3f(89.0/255.0, 237.0/255.0, 52/255.0),
        vec3f(88.0/255.0, 236.0/255.0, 89/255.0),
        vec3f(90.0/255.0, 237.0/255.0, 126/255.0),
        vec3f(89.0/255.0, 237.0/255.0, 162/255.0),
        vec3f(88.0/255.0, 237.0/255.0, 201/255.0),
        vec3f(89.0/255.0, 236.0/255.0, 237/255.0),
        vec3f(124.0/255.0, 14.0/255.0, 13/255.0),
        vec3f(126.0/255.0, 15.0/255.0, 53/255.0),
        vec3f(125.0/255.0, 15.0/255.0, 89/255.0),
        vec3f(126.0/255.0, 14.0/255.0, 125/255.0),
        vec3f(126.0/255.0, 16.0/255.0, 162/255.0),
        vec3f(126.0/255.0, 13.0/255.0, 200/255.0),
        vec3f(126.0/255.0, 15.0/255.0, 237/255.0),
        vec3f(126.0/255.0, 52.0/255.0, 16/255.0),
        vec3f(126.0/255.0, 52.0/255.0, 52/255.0),
        vec3f(126.0/255.0, 52.0/255.0, 89/255.0),
        vec3f(126.0/255.0, 52.0/255.0, 125/255.0),
        vec3f(125.0/255.0, 52.0/255.0, 163/255.0),
        vec3f(126.0/255.0, 51.0/255.0, 199/255.0),
        vec3f(126.0/255.0, 52.0/255.0, 237/255.0),
        vec3f(126.0/255.0, 89.0/255.0, 16/255.0),
        vec3f(126.0/255.0, 88.0/255.0, 51/255.0),
        vec3f(126.0/255.0, 89.0/255.0, 88/255.0),
        vec3f(124.0/255.0, 88.0/255.0, 126/255.0),
        vec3f(126.0/255.0, 89.0/255.0, 163/255.0),
        vec3f(126.0/255.0, 90.0/255.0, 200/255.0),
        vec3f(126.0/255.0, 88.0/255.0, 238/255.0),
        vec3f(126.0/255.0, 126.0/255.0, 15/255.0),
        vec3f(125.0/255.0, 125.0/255.0, 51/255.0),
        vec3f(126.0/255.0, 125.0/255.0, 89/255.0),
        vec3f(126.0/255.0, 126.0/255.0, 126/255.0),
        vec3f(126.0/255.0, 126.0/255.0, 163/255.0),
        vec3f(127.0/255.0, 126.0/255.0, 199/255.0),
        vec3f(126.0/255.0, 126.0/255.0, 235/255.0),
        vec3f(126.0/255.0, 163.0/255.0, 14/255.0),
        vec3f(124.0/255.0, 162.0/255.0, 52/255.0),
        vec3f(126.0/255.0, 162.0/255.0, 89/255.0),
        vec3f(126.0/255.0, 164.0/255.0, 126/255.0),
        vec3f(126.0/255.0, 163.0/255.0, 162/255.0),
        vec3f(126.0/255.0, 163.0/255.0, 201/255.0),
        vec3f(125.0/255.0, 163.0/255.0, 237/255.0),
        vec3f(127.0/255.0, 200.0/255.0, 16/255.0),
        vec3f(125.0/255.0, 199.0/255.0, 52/255.0),
        vec3f(126.0/255.0, 200.0/255.0, 89/255.0),
        vec3f(126.0/255.0, 199.0/255.0, 125/255.0),
        vec3f(126.0/255.0, 199.0/255.0, 163/255.0),
        vec3f(126.0/255.0, 200.0/255.0, 201/255.0),
        vec3f(126.0/255.0, 199.0/255.0, 236/255.0),
        vec3f(126.0/255.0, 236.0/255.0, 15/255.0),
        vec3f(125.0/255.0, 237.0/255.0, 51/255.0),
        vec3f(126.0/255.0, 236.0/255.0, 88/255.0),
        vec3f(126.0/255.0, 237.0/255.0, 125/255.0),
        vec3f(125.0/255.0, 237.0/255.0, 163/255.0),
        vec3f(126.0/255.0, 237.0/255.0, 200/255.0),
        vec3f(125.0/255.0, 236.0/255.0, 236/255.0),
        vec3f(163.0/255.0, 15.0/255.0, 15/255.0),
        vec3f(162.0/255.0, 15.0/255.0, 51/255.0),
        vec3f(162.0/255.0, 15.0/255.0, 90/255.0),
        vec3f(163.0/255.0, 15.0/255.0, 127/255.0),
        vec3f(162.0/255.0, 15.0/255.0, 162/255.0),
        vec3f(163.0/255.0, 14.0/255.0, 200/255.0),
        vec3f(163.0/255.0, 15.0/255.0, 236/255.0),
        vec3f(162.0/255.0, 51.0/255.0, 14/255.0),
        vec3f(162.0/255.0, 52.0/255.0, 51/255.0),
        vec3f(163.0/255.0, 52.0/255.0, 90/255.0),
        vec3f(162.0/255.0, 52.0/255.0, 126/255.0),
        vec3f(163.0/255.0, 51.0/255.0, 162/255.0),
        vec3f(163.0/255.0, 53.0/255.0, 199/255.0),
        vec3f(164.0/255.0, 51.0/255.0, 238/255.0),
        vec3f(163.0/255.0, 89.0/255.0, 14/255.0),
        vec3f(163.0/255.0, 89.0/255.0, 53/255.0),
        vec3f(162.0/255.0, 88.0/255.0, 88/255.0),
        vec3f(163.0/255.0, 89.0/255.0, 126/255.0),
        vec3f(164.0/255.0, 90.0/255.0, 163/255.0),
        vec3f(162.0/255.0, 89.0/255.0, 200/255.0),
        vec3f(164.0/255.0, 89.0/255.0, 237/255.0),
        vec3f(163.0/255.0, 126.0/255.0, 16/255.0),
        vec3f(162.0/255.0, 125.0/255.0, 52/255.0),
        vec3f(163.0/255.0, 125.0/255.0, 88/255.0),
        vec3f(163.0/255.0, 126.0/255.0, 125/255.0),
        vec3f(162.0/255.0, 126.0/255.0, 164/255.0),
        vec3f(163.0/255.0, 126.0/255.0, 200/255.0),
        vec3f(162.0/255.0, 126.0/255.0, 236/255.0),
        vec3f(163.0/255.0, 162.0/255.0, 14/255.0),
        vec3f(163.0/255.0, 163.0/255.0, 52/255.0),
        vec3f(163.0/255.0, 163.0/255.0, 89/255.0),
        vec3f(163.0/255.0, 162.0/255.0, 126/255.0),
        vec3f(164.0/255.0, 164.0/255.0, 164/255.0),
        vec3f(162.0/255.0, 162.0/255.0, 199/255.0),
        vec3f(164.0/255.0, 163.0/255.0, 236/255.0),
        vec3f(163.0/255.0, 199.0/255.0, 14/255.0),
        vec3f(163.0/255.0, 200.0/255.0, 51/255.0),
        vec3f(161.0/255.0, 199.0/255.0, 89/255.0),
        vec3f(163.0/255.0, 199.0/255.0, 126/255.0),
        vec3f(163.0/255.0, 201.0/255.0, 163/255.0),
        vec3f(163.0/255.0, 200.0/255.0, 199/255.0),
        vec3f(163.0/255.0, 200.0/255.0, 238/255.0),
        vec3f(162.0/255.0, 237.0/255.0, 14/255.0),
        vec3f(163.0/255.0, 236.0/255.0, 52/255.0),
        vec3f(163.0/255.0, 237.0/255.0, 90/255.0),
        vec3f(163.0/255.0, 237.0/255.0, 126/255.0),
        vec3f(163.0/255.0, 236.0/255.0, 162/255.0),
        vec3f(163.0/255.0, 236.0/255.0, 200/255.0),
        vec3f(162.0/255.0, 236.0/255.0, 237/255.0),
        vec3f(200.0/255.0, 15.0/255.0, 14/255.0),
        vec3f(199.0/255.0, 15.0/255.0, 52/255.0),
        vec3f(200.0/255.0, 15.0/255.0, 89/255.0),
        vec3f(199.0/255.0, 14.0/255.0, 125/255.0),
        vec3f(201.0/255.0, 15.0/255.0, 164/255.0),
        vec3f(199.0/255.0, 13.0/255.0, 199/255.0),
        vec3f(199.0/255.0, 15.0/255.0, 237/255.0),
        vec3f(199.0/255.0, 52.0/255.0, 16/255.0),
        vec3f(200.0/255.0, 52.0/255.0, 52/255.0),
        vec3f(199.0/255.0, 52.0/255.0, 88/255.0),
        vec3f(239.0/255.0, 239.0/255.0, 239/255.0)
);

fn fuzzy_equals(a: vec3f, b: vec3f) -> bool {
    let diff = abs(a - b);
    return diff.r <= fuzziness && diff.g <= fuzziness && diff.b <= fuzziness;
}

@group(0) @binding(0) var<storage, read_write> tiles: array<u32, numTiles>;
@group(0) @binding(1) var texture: texture_2d<f32>;
@compute @workgroup_size(1)
fn cs(
    @builtin(global_invocation_id) global_invocation_id: vec3u,
    @builtin(workgroup_id) workgroup_id: vec3u,
    @builtin(local_invocation_id) local_invocation_id: vec3u,
) {
    let size = textureDimensions(texture, 0);
    let tile = global_invocation_id.x;
    let positionX = (tile % columns) * tileWidth + (tileWidth / 2);
    let positionY = tile / columns * tileHeight + (tileHeight / 2);
    let tileCenterPos = vec2u(
        positionX, positionY
    );

    let color = textureLoad(texture, tileCenterPos, 0);

    for(var ii: u32 = 0; ii < 256; ii++) {
        if (fuzzy_equals(palette[ii], color.rgb)) {
            tiles[tile] = ii;
            return;
        }
    }

    // sentinel error value
    tiles[tile] = 999;
}